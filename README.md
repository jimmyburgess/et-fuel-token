et-fuel-token
==============

fuel-token-middleware npm package for applications generated by the [base-app-generator](https://github.exacttarget.com/DevelopmentTools/base-app-generator)

Express Middleware for managing Fuel tokens

Initializes from a JWT, then manages a .fuel attribute on the Express session which contains valid tokens.

Installation
------------

Available on the [ET NPM registry / mirror](https://github.exacttarget.com/gist/avernacchia/df763e6812e8c59a8aef)

	$ npm install --registry http://npm.xexacttargetapps.com/ et-fuel-token

Directly from ghe:

	$ npm install 'git+ssh://git@github.exacttarget.com:NodeModules/et-fuel-token'

Dependencies
------------

 - request : https://github.com/mikeal/request
 - jwt-simple : https://github.com/hokaccha/node-jwt-simple

Usage
-----

The fuel-token-middleware takes two arguments, an object containing stackConfigs and an object containing options.

    function fuelTokenMiddleware( stackConfigs, options ) { ... }

The stackConfigs object contains entries for each stack you would like your app to support. The key names correspond to the organization.stackKey attribute in a JWT.

Each entry should contain an appId, clientId, clientSecret, appSignature, and authUrl which you receive when registering your app in App Center.

    var fuelTokenMiddleware = require( 'fuel-token-middleware' );

    ...

    app.use( fuelTokenMiddleware({
        QA1S1: {
            appId: 'qa1s1-app-id-from-app-center'
            , clientId: 'qa1s1-client-id-from-app-center'
            , clientSecret: 'qa1s1-client-secret-from-app-center'
            , appSignature: 'qa1s1-app-signature-from-app-center'
            , authUrl: 'https://auth-qa1s1.exacttargetapis.com/v1/requestToken?legacy=1'
        }
        , QA2S1: {
            appId: 'qa2s1-app-id-from-app-center'
            , clientId: 'qa2s1-client-id-from-app-center'
            , clientSecret: 'qa2s1-client-secret-from-app-center'
            , appSignature: 'qa2s1-app-signature-from-app-center'
            , authUrl: 'https://auth-qa2s1.exacttargetapis.com/v1/requestToken?legacy=1'
        }
    } ) );

Once the middleware is in place your req.session.fuel will always contain a valid Fuel and legacyToken.

	app.get( '/', function( req, res ) {
		res.setHeader( 'Content-type', 'text/plain' );
		res.send( JSON.stringify( {
			token: req.session.fuel.token, // Fuel API access token
			refreshToken: req.session.fuel.refreshToken, // Fuel API refresh token
			legacyToken: req.session.fuel.legacyToken // Legacy Oauth Token for OpenRasta routes
		}, null, 4 ) );
	} );

Prior to using the fuel-token-middleware you must establish an express session by adding the express session middleware. Because the session will contain private refresh tokens this session store should be on the server. I suggest using MemoryStore for single instance apps, RedisStore for multi instance apps.
